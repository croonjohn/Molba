{% extends 'board/base.html' %}
{% load hitcount_tags %}

{% block content %}
    <div class="post">
        <div class="date">
            작성일자: {{ freepost.published_date }}
        </div>
        <div class="hitcount">
            조회수: {% get_hit_count for freepost %}
        </div>
        <div class="number_of_edits">수정횟수: {{ freepost.number_of_edits }}</div>
        <div class="last_edit_date">마지막 수정일시: {{ freepost.last_edit_date }}</div>
        <span class="control hidden" id = "control_id{{ forloop.counter0 }}">
            <a class="btn btn-default" href="{% url 'freepost_edit' pk=freepost.pk %}" onclick="return confirm('글을 수정하시겠습니까?')">수정</a>
            <a class="btn btn-default" href="{% url 'freepost_remove' pk=freepost.pk %}" onclick="return confirm('정말 삭제하시겠습니까?')">삭제</a>
        </span>
        <div class="author_name">{{ freepost.author.nickname }}</div>
        <h1>{{ freepost.title }}</h1>
        {% if freepost.image %}
            <img class="post_image" src="{{ freepost.image.url }}" alt="">
        {% endif %}
        <div class="content">{{ freepost.content|linebreaksbr }}</div>
        <input type="button" class="post_like" name="{{ freepost.pk }}" value="좋아요">
        <span class="like_count" id="count{{ freepost.pk }}_like">{{ freepost.total_likes }}</span>
        <input type="button" class="post_hate" name="{{ freepost.pk }}" value="싫어요">
        <span class="hate_count" id="count{{ freepost.pk }}_hate">{{ freepost.total_hates }}</span>
    </div>
    <a class="btn btn-default" href="{% url 'freepost_list' %}">목록</a>
    {% if user.is_authenticated %}
        <a class="btn btn-default" href="{% url 'freepost_new' %}">글쓰기</a>
    {% endif %}
    <hr>
    {% if user.is_authenticated %}
        <form method="POST" class="post-form" action="{% url 'add_freecomment_to_freepost' pk=freepost.pk %}">
            {% csrf_token %}
            <input type="text" name="freecomment_form" class="comment_form">
            <button type="submit" class="save btn btn-default" onclick="return confirm('댓글을 등록하시겠습니까?')">등록</button>
        </form>
    {% else %}
        <div class="need_login"><a href="{% url 'login' %}" class="top-menu">로그인</a> 후 댓글 달기</div>
    {% endif %}
    {% for freecomment in freepost.freecomments.all %}
        <div class="comment">
            <div class="date">{{ freecomment.published_date }}</div>
            <div class="number_of_edits">수정횟수: {{ freecomment.number_of_edits }}</div>
            <div class="last_edit_date">마지막 수정일시: {{ freecomment.last_edit_date }}</div>
            <span class="control hidden" id = "control_id{{ forloop.counter0 }}">
                <a class="btn btn-default" href="{% url 'freecomment_edit' pk=freecomment.pk %}" onclick="return confirm('글을 수정하시겠습니까?')">수정</a>
                <a class="btn btn-default" href="{% url 'freecomment_remove' pk=freecomment.pk %}" onclick="return confirm('정말 삭제하시겠습니까?')">삭제</a>
            </span>
            <div class="author_name">{{ freecomment.author.nickname }}</div>
            <div class="content">{{ freecomment.content|linebreaks }}</div>
            <input type="button" class="comment_like" name="{{ freecomment.pk }}" value="좋아요">
            <span class="like_count" id="count{{ freecomment.pk }}_like_comment">{{ freecomment.total_likes }}</span>
            <input type="button" class="comment_hate" name="{{ freecomment.pk }}" value="싫어요">
            <span class="hate_count" id="count{{ freecomment.pk }}_hate_comment">{{ freecomment.total_hates }}</span>
        </div>
    {% empty %}
        <div class="empty">댓글이 없습니다.</div>
    {% endfor %}
    <a class="btn btn-default" href="{% url 'freepost_list' %}">목록</a>
    {% if user.is_authenticated %}
        <a class="btn btn-default" href="{% url 'freepost_new' %}">글쓰기</a>
    {% endif %}
    <script type="text/javascript">
        // 좋아요 버튼 처리. 출처 : 초보몽키의 개발공부로그
        // 버튼 클릭 > ajax통신 (like url로 전달) > views의 like 메소드에서 리턴하는 값 전달받기 > 성공시 콜백 호출
        $('.post_like').click(function(){
            var pk = $(this).attr('name') // 클릭한 요소의 attribute 중 name의 값을 가져온다.
            $.ajax({
                type: "POST", // 데이터를 전송하는 방법을 지정한다.
                url: "{% url 'freepost_like' %}", // 통신할 url을 지정한다.
                data: {'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}'}, // 서버로 데이터를 전송할 때 이 옵션을 사용한다.
                dataType: "json", // 서버측에서 전송한 데이터를 어떤 형식의 데이터로서 해석할 것인가를 지정한다. 없으면 알아서 판단한다.
                // 서버측에서 전송한 데이터 views.py like 메소드
                // context = {'likes_count' : freepost.total_likes, 'message' : message}
                // json.dump(context)를 통해서 json 형식으로 전달된다
                success: function(response){ // 성공했을 때 호출할 콜백을 지정한다.
                  id = $(this).attr('name')
                  $('#count'+ pk+'_like').html(response.likes_count);
                  alert(response.message);
                },
                error:function(request,status,error){
                  alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                }
            });
        })
        $('.post_hate').click(function(){
            var pk = $(this).attr('name') // 클릭한 요소의 attribute 중 name의 값을 가져온다.
            $.ajax({
                type: "POST", // 데이터를 전송하는 방법을 지정한다.
                url: "{% url 'freepost_hate' %}", // 통신할 url을 지정한다.
                data: {'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}'}, // 서버로 데이터를 전송할 때 이 옵션을 사용한다.
                dataType: "json", // 서버측에서 전송한 데이터를 어떤 형식의 데이터로서 해석할 것인가를 지정한다. 없으면 알아서 판단한다.
                // 서버측에서 전송한 데이터 views.py hate 메소드
                // context = {'hates_count' : freepost.total_hates, 'message' : message}
                // json.dump(context)를 통해서 json 형식으로 전달된다
                success: function(response){ // 성공했을 때 호출할 콜백을 지정한다.
                  id = $(this).attr('name')
                  $('#count'+ pk+'_hate').html(response.hates_count);
                  alert(response.message);
                },
                error:function(request,status,error){
                  alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                }
            });
        })
        $('.comment_like').click(function(){
            var pk = $(this).attr('name') // 클릭한 요소의 attribute 중 name의 값을 가져온다.
            $.ajax({
                type: "POST", // 데이터를 전송하는 방법을 지정한다.
                url: "{% url 'freecomment_like' %}", // 통신할 url을 지정한다.
                data: {'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}'}, // 서버로 데이터를 전송할 때 이 옵션을 사용한다.
                dataType: "json", // 서버측에서 전송한 데이터를 어떤 형식의 데이터로서 해석할 것인가를 지정한다. 없으면 알아서 판단한다.
                // 서버측에서 전송한 데이터 views.py like 메소드
                // context = {'likes_count' : freecomment.total_likes, 'message' : message}
                // json.dump(context)를 통해서 json 형식으로 전달된다
                success: function(response){ // 성공했을 때 호출할 콜백을 지정한다.
                  id = $(this).attr('name')
                  $('#count'+ pk+'_like_comment').html(response.likes_count);
                  alert(response.message);
                },
                error:function(request,status,error){
                  alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                }
            });
        })
        $('.comment_hate').click(function(){
            var pk = $(this).attr('name') // 클릭한 요소의 attribute 중 name의 값을 가져온다.
            $.ajax({
                type: "POST", // 데이터를 전송하는 방법을 지정한다.
                url: "{% url 'freecomment_hate' %}", // 통신할 url을 지정한다.
                data: {'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}'}, // 서버로 데이터를 전송할 때 이 옵션을 사용한다.
                dataType: "json", // 서버측에서 전송한 데이터를 어떤 형식의 데이터로서 해석할 것인가를 지정한다. 없으면 알아서 판단한다.
                // 서버측에서 전송한 데이터 views.py hate 메소드
                // context = {'hates_count' : freecomment.total_hates, 'message' : message}
                // json.dump(context)를 통해서 json 형식으로 전달된다
                success: function(response){ // 성공했을 때 호출할 콜백을 지정한다.
                  id = $(this).attr('name')
                  $('#count'+ pk+'_hate_comment').html(response.hates_count);
                  alert(response.message);
                },
                error:function(request,status,error){
                  alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                }
            });
        })
    </script>
{% endblock %}
